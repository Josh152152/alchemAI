<!doctype html>
<html>
<head>
    <title>Job Summary Agent Chat</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #chat { background: #f9f9f9; border-radius: 8px; padding: 16px; height: 320px; overflow-y: auto; margin-bottom: 12px; }
        .user { color: #333; font-weight: bold; margin: 8px 0 2px 0; }
        .ai { color: #1976d2; margin: 4px 0 10px 0; }
        #input-area { display: flex; gap: 6px; }
        #input-box { flex: 1; }
        button { padding: 6px 16px; border-radius: 6px; border: none; background: #1976d2; color: white; }
        button:disabled { background: #bbb; }
    </style>
</head>
<body>
    <h2>Job Ad Chat Agent</h2>
    <div id="chat"></div>
    <form id="input-area" autocomplete="off">
        <input id="input-box" type="text" autocomplete="off" placeholder="Type your message..." required>
        <button id="send-btn" type="submit">Send</button>
    </form>
    <script>
        let history = [];

        function appendMessage(role, content) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = role;
            div.innerHTML = `<div><strong>${role === "user" ? "You" : "Agent"}:</strong></div><div>${content.replace(/\n/g,'<br>')}</div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        document.getElementById("input-area").onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById("input-box");
            const userMsg = input.value.trim();
            if (!userMsg) return;

            appendMessage("user", userMsg);
            history.push({ role: "user", content: userMsg });
            input.value = "";
            document.getElementById("send-btn").disabled = true;

            // POST the full message history
            try {
                const res = await fetch("/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ job_info: history })
                });
                const data = await res.json();

                // AI reply
                const aiMsg = data.reply || "No reply from agent.";
                appendMessage("ai", aiMsg);
                history.push({ role: "assistant", content: aiMsg });
            } catch (err) {
                appendMessage("ai", "Error connecting to backend.");
            } finally {
                document.getElementById("send-btn").disabled = false;
            }
        };
    </script>
</body>
</html>
